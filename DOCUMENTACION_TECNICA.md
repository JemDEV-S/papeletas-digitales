# Documentación Técnica - Sistema de Papeletas Digitales

## Descripción General

El Sistema de Papeletas Digitales es una aplicación web desarrollada en Laravel 12 que gestiona solicitudes de permisos laborales para la Municipalidad Distrital de San Jerónimo. El sistema implementa un flujo de aprobación multinivel con firma digital certificada mediante FIRMA PERÚ, seguimiento físico en tiempo real mediante dispositivos biométricos ZKTeco, y reportería completa para recursos humanos.

## Arquitectura del Sistema

El sistema utiliza el patrón arquitectónico MVC (Model-View-Controller) de Laravel con una capa de servicios para la lógica de negocio compleja. La arquitectura se divide en tres capas principales: presentación (Blade templates con Tailwind CSS), lógica de negocio (controladores y servicios), y persistencia (Eloquent ORM con MySQL).

## Stack Tecnológico

El backend está construido con PHP 8.2+ y Laravel 12, utilizando MySQL 8.0+ como base de datos principal. El frontend combina Blade templates con Tailwind CSS para estilos y JavaScript ES6+ para interactividad. La autenticación se maneja mediante Laravel Breeze con Sanctum para tokens API. Las firmas digitales se procesan a través del componente web de FIRMA PERÚ, mientras que los dispositivos biométricos ZKTeco G3 se integran mediante un agente PHP independiente. La exportación de reportes utiliza Maatwebsite Excel y Barryvdh DomPDF, y las tareas asincrónicas se procesan mediante colas con el driver de base de datos.

## Modelos de Datos

El modelo central del sistema es PermissionRequest, que representa una solicitud de permiso. Cada solicitud pertenece a un User (empleado) y tiene un PermissionType que define las reglas y límites. El flujo de aprobación se gestiona mediante el modelo Approval, que registra cada nivel de aprobación con su estado y comentarios. El modelo DigitalSignature almacena las firmas digitales con metadata completa del certificado y validación de integridad. Los documentos adjuntos se gestionan mediante el modelo Document, que incluye validación de hash SHA256. El seguimiento físico se realiza a través del modelo PermissionTracking, que registra la salida y entrada real del empleado con cálculo automático de horas utilizadas. Los dispositivos ZKTeco se autentican mediante el modelo AgentToken, que gestiona tokens de acceso con expiración configurable.

## Flujo de Trabajo Principal

El flujo inicia cuando el empleado crea una solicitud en estado DRAFT, seleccionando el tipo de permiso y justificando la razón. Posteriormente, el empleado firma digitalmente su solicitud mediante FIRMA PERÚ, generando un PDF certificado. Una vez firmada, la solicitud pasa al estado PENDING_IMMEDIATE_BOSS y se notifica al jefe inmediato. El jefe inmediato revisa la solicitud y puede aprobarla (firmando digitalmente) o rechazarla con justificación. Si es aprobada, la solicitud avanza al estado PENDING_HR y se notifica al jefe de recursos humanos. El jefe de RRHH realiza la aprobación final, también con firma digital, y la solicitud pasa al estado APPROVED. En este momento, el sistema crea automáticamente un registro de PermissionTracking en estado PENDING. Cuando el empleado sale físicamente de las instalaciones, el dispositivo ZKTeco captura el evento y el sistema actualiza el tracking a estado OUT, registrando la hora exacta de salida. Al regresar, el dispositivo captura nuevamente el evento y el sistema actualiza a estado RETURNED, calculando automáticamente las horas reales utilizadas. Si el empleado excede el tiempo esperado, el sistema marca automáticamente el tracking como OVERDUE y genera alertas.

## Integración con FIRMA PERÚ

La integración con FIRMA PERÚ utiliza un servicio especializado (FirmaPeruService) que gestiona la autenticación mediante tokens JWT obtenidos de la plataforma gubernamental. El proceso inicia con la generación de un token temporal que se almacena en caché junto con los parámetros de firma. El componente JavaScript de FIRMA PERÚ descarga el documento original desde el endpoint del sistema, presenta al usuario sus certificados digitales disponibles, y ejecuta la firma utilizando el certificado seleccionado. El documento firmado se carga automáticamente al servidor mediante un endpoint API dedicado, donde se valida la integridad del PDF y se almacena de forma segura. El sistema registra metadata completa de la firma incluyendo el hash del documento, serial del certificado, algoritmo utilizado y distinguished name del firmante. Cada solicitud puede tener hasta tres firmas digitales: la del empleado, la del jefe inmediato y la del jefe de RRHH.

## Integración con Dispositivos ZKTeco

Los dispositivos biométricos ZKTeco G3 se integran mediante agentes PHP independientes que se ejecutan continuamente en el servidor. Cada agente mantiene una base de datos SQLite local para operación offline y se comunica con el servidor Laravel mediante API REST. El agente sincroniza periódicamente la lista de empleados activos desde el servidor hacia el dispositivo ZKTeco, captura eventos de acceso (entrada y salida) en tiempo real, y los envía al servidor mediante el endpoint API de eventos. El servidor valida el DNI del empleado, busca registros de tracking activos, y actualiza el estado correspondiente. La autenticación de los agentes utiliza tokens únicos con prefijo "zka_" que tienen capacidades configurables y expiración automática. El sistema soporta hasta cinco agentes simultáneos para múltiples ubicaciones físicas, cada uno operando de forma independiente con monitoreo centralizado desde el panel de administración.

## Sistema de Reportería

El módulo de reportería proporciona diez reportes especializados accesibles desde el dashboard de recursos humanos. Los reportes incluyen análisis de solicitudes por estado, tipo y departamento con visualizaciones mediante Chart.js. El análisis de tiempos de aprobación calcula promedios y medianas por nivel de aprobación. El reporte de ausentismo analiza patrones de uso de permisos y horas acumuladas por empleado. El seguimiento en tiempo real muestra empleados actualmente fuera de oficina con alertas de atrasos. Los reportes de desempeño de supervisores evalúan velocidad de aprobación y tasa de rechazo. El análisis de tendencias temporales identifica picos y patrones estacionales. El reporte de cumplimiento detecta solicitudes sin documentación completa o sin firmas digitales. Todos los reportes son exportables a Excel mediante Maatwebsite Excel y algunos también generan PDFs mediante DomPDF. Los filtros de fecha son configurables y los datos se calculan en tiempo real mediante consultas optimizadas de Eloquent.

## Seguridad

El sistema implementa múltiples capas de seguridad comenzando con autenticación obligatoria mediante Laravel Breeze y verificación de email requerida. La autorización se gestiona mediante cuatro roles principales: empleado, jefe inmediato, jefe de RRHH y administrador, cada uno con permisos específicos validados mediante middleware. Las firmas digitales utilizan certificados X.509 válidos del Estado Peruano con validación de integridad mediante hashes SHA256. Todos los documentos sensibles se almacenan fuera del directorio web público con permisos restrictivos. Las contraseñas se encriptan mediante Bcrypt con doce rondas de hashing. Los tokens de agentes ZKTeco tienen expiración configurable y se revocan automáticamente al vencimiento. La protección CSRF está habilitada para todas las rutas web, mientras que las rutas API utilizan autenticación por token. Los archivos cargados se validan estrictamente por tipo MIME y tamaño máximo. Todas las acciones críticas se registran en logs para auditoría completa.

## Notificaciones

El sistema de notificaciones maneja múltiples tipos de eventos mediante el modelo Notification con soporte para categorías y prioridades. Las notificaciones se generan automáticamente cuando se envía una solicitud, se aprueba o rechaza una solicitud, se detecta un atraso en el regreso, o se realizan cambios administrativos. Cada notificación incluye título descriptivo, mensaje completo, datos adicionales en formato JSON, y referencia a la entidad relacionada. Las notificaciones pueden enviarse también por email de forma configurable mediante el sistema de colas. Los usuarios acceden a sus notificaciones desde el centro de notificaciones en el header, donde pueden marcar como leídas o eliminarlas. Las notificaciones tienen expiración configurable y se limpian automáticamente después del vencimiento.

## Comandos Artisan

El sistema incluye varios comandos Artisan personalizados para tareas administrativas. El comando agent:token gestiona tokens de autenticación para agentes ZKTeco permitiendo crear, listar, revocar y limpiar tokens expirados. El comando tracking:auto-register-returns ejecuta el registro automático de retornos a las 18:00 horas para empleados que no registraron su regreso, marcando automáticamente como "regreso registrado por el sistema". El comando import:excel-data permite importar datos masivos de empleados desde archivos Excel. Todos los comandos incluyen opciones de dry-run para simulación sin cambios reales y logging detallado de operaciones realizadas.

## Despliegue y Configuración

Para desplegar el sistema en producción, primero se deben configurar las variables de entorno en el archivo .env, incluyendo conexión a base de datos, configuración de email, y URLs de servicios externos. El archivo fwAuthorization.json debe crearse en la raíz con las credenciales de FIRMA PERÚ obtenidas de la plataforma gubernamental. Las migraciones se ejecutan mediante php artisan migrate para crear el esquema de base de datos. El seeder inicial puebla roles, tipos de permisos y un usuario administrador. Los agentes ZKTeco se configuran ejecutando el instalador en el directorio zkteco-agent, que guía interactivamente la configuración de IP del dispositivo, URL del servidor y token de autenticación. Las tareas programadas requieren configurar un cron job en el servidor que ejecute php artisan schedule:run cada minuto. Los permisos de storage deben configurarse para permitir escritura en directorios de logs, cache y archivos cargados. Se recomienda habilitar HTTPS en producción, configurar Redis para cache y colas, y establecer monitoreo de logs.

## Mantenimiento

El mantenimiento regular incluye revisión periódica de logs en storage/logs para detectar errores recurrentes, limpieza de archivos temporales mediante comandos Artisan, rotación de logs cada semana para evitar archivos excesivamente grandes, y backup diario de la base de datos y directorio storage. Los tokens de agentes deben revisarse mensualmente para revocar aquellos sin uso reciente. Las firmas digitales antiguas pueden archivarse después de un período de retención legal. El estado de los dispositivos ZKTeco debe monitorearse mediante el panel de administración para detectar dispositivos offline. Las actualizaciones de Laravel y dependencias deben aplicarse siguiendo el ciclo de versiones LTS. Se recomienda mantener un entorno de staging para probar cambios antes de producción.

## Endpoints API

El sistema expone endpoints API sin protección CSRF para integración con servicios externos. Los endpoints de FIRMA PERÚ incluyen POST /api/firma-peru/param para parámetros de firma, GET /api/firma-peru/document/{id} para descargar documento original, y POST /api/firma-peru/upload/{id} para recibir documento firmado. Los endpoints de agentes ZKTeco incluyen POST /api/agent/register para registrar agente, POST /api/agent/heartbeat para latido de vida cada treinta segundos, GET /api/agent/employees para sincronizar empleados, POST /api/agent/access-events para enviar eventos de acceso, y GET /api/agent/permission-trackings/{dni} para obtener seguimientos activos. Todos los endpoints de agentes requieren autenticación mediante token en header Authorization o X-Agent-Token. Los endpoints de notificaciones permiten consulta de nuevas notificaciones y operaciones de lectura/eliminación mediante AJAX. Las respuestas son siempre en formato JSON con estructura consistente de success, message y data.

## Monitoreo y Logs

El sistema registra eventos importantes en storage/logs/laravel.log con nivel de detalle configurable. Se registran todas las operaciones CRUD de solicitudes, aprobaciones y rechazos con usuario responsable, intentos de autenticación fallidos con IP de origen, errores de integración con FIRMA PERÚ y ZKTeco, cambios de estado de solicitudes con timestamp exacto, descargas de documentos sensibles, y operaciones administrativas críticas. El monitoreo recomendado incluye alertas para solicitudes pendientes mayor a cuarenta y ocho horas, verificación diaria de estado de agentes ZKTeco mediante heartbeat, revisión de integridad de firmas digitales almacenadas, y análisis de errores recurrentes en logs. Las métricas clave incluyen tiempo promedio de aprobación por nivel, tasa de rechazo por departamento, disponibilidad del servicio FIRMA PERÚ, y latencia de sincronización con ZKTeco.
