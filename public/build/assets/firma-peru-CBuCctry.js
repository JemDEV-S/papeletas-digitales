class d{constructor(){this.port=48596,this.jsUrl="https://apps.firmaperu.gob.pe/web/clienteweb/firmaperu.min.js",this.currentPermissionId=null,this.currentStage=null,this.isProcessing=!1,this.scriptLoaded=!1,console.log("üöÄ Inicializando FirmaPeruIntegration..."),this.init()}init(){this.loadFirmaPeruScript(),this.setupEventListeners(),this.addComponentDiv(),this.ensureJQueryConfiguration()}loadFirmaPeruScript(){if(document.getElementById("firma-peru-script"))console.log("üì¶ Script FIRMA PER√ö ya existe, verificando funciones..."),this.verifyScriptFunctions();else{console.log("üîÑ Cargando script de FIRMA PER√ö...");const e=document.createElement("script");e.id="firma-peru-script",e.src=this.jsUrl,e.onload=()=>{console.log("üì¶ FIRMA PER√ö script cargado desde servidor"),setTimeout(()=>{this.verifyScriptFunctions()},100)},e.onerror=()=>{console.error("‚ùå Error al cargar script de FIRMA PER√ö"),this.showError("Error al cargar el componente de firma digital")},document.head.appendChild(e)}}verifyScriptFunctions(e=0,t=20){const i=["startSignature"];let r=!0;console.log(`üîç Verificando funciones de FIRMA PER√ö (intento ${e+1}/${t})`);for(const s of i)typeof window[s]!="function"?(console.warn(`‚ö†Ô∏è Funci√≥n ${s} no disponible a√∫n`),r=!1):console.log(`‚úÖ Funci√≥n ${s} disponible`);if(typeof window.jqFirmaPeru>"u"&&(console.warn("‚ö†Ô∏è jqFirmaPeru no disponible a√∫n"),r=!1),r){console.log("‚úÖ Todas las funciones de FIRMA PER√ö est√°n disponibles"),this.scriptLoaded=!0;return}if(e<t){console.log("‚è≥ Esperando funciones de FIRMA PER√ö...");const s=Math.min(1e3,200+e*100);setTimeout(()=>{this.verifyScriptFunctions(e+1,t)},s)}else console.error("‚ùå Timeout: No se pudieron cargar las funciones de FIRMA PER√ö despu√©s de m√∫ltiples intentos"),console.log("üîç Estado final:",{startSignature:typeof window.startSignature,jqFirmaPeru:typeof window.jqFirmaPeru,jQuery:typeof window.jQuery,windowKeys:Object.keys(window).filter(s=>s.toLowerCase().includes("firma"))})}addComponentDiv(){if(!document.getElementById("addComponent")){const e=document.createElement("div");e.id="addComponent",e.style.display="none",document.body.appendChild(e)}}ensureJQueryConfiguration(){if(typeof window.jqFirmaPeru>"u")if(console.error("‚ùå jqFirmaPeru no est√° definido. Verificando jQuery..."),typeof window.jQuery<"u")window.jqFirmaPeru=window.jQuery.noConflict(!0),console.log("‚úÖ jqFirmaPeru configurado usando jQuery existente");else if(typeof window.$<"u")window.jqFirmaPeru=window.$,console.log("‚úÖ jqFirmaPeru configurado usando $");else return console.error("‚ùå jQuery no est√° disponible. FIRMA PER√ö no funcionar√°."),this.showError("jQuery no est√° disponible. Por favor, recarga la p√°gina."),!1;else console.log("‚úÖ jqFirmaPeru ya est√° configurado");return!0}async waitForFirmaPeruComponent(e=10,t=500){console.log("üîç Verificando disponibilidad del componente FIRMA PER√ö...");for(let i=0;i<e;i++){if(this.scriptLoaded&&typeof window.startSignature=="function"&&typeof window.jqFirmaPeru<"u")return console.log("‚úÖ Componente FIRMA PER√ö disponible"),!0;console.log(`‚è≥ Intento ${i+1}/${e} - Esperando componente...`),await new Promise(r=>setTimeout(r,t))}return console.error("‚ùå Timeout esperando componente FIRMA PER√ö"),console.log("Estado del componente:",{scriptLoaded:this.scriptLoaded,startSignatureExists:typeof window.startSignature,jqFirmaPeruExists:typeof window.jqFirmaPeru,windowKeys:Object.keys(window).filter(i=>i.includes("firma")||i.includes("Firma"))}),!1}setupEventListeners(){document.addEventListener("click",e=>{e.target.classList.contains("btn-sign-employee")?this.initiateEmployeeSignature(e.target.dataset.permissionId):e.target.classList.contains("btn-sign-level1")?this.initiateLevel1Signature(e.target.dataset.permissionId):e.target.classList.contains("btn-sign-level2")&&this.initiateLevel2Signature(e.target.dataset.permissionId)}),document.addEventListener("click",e=>{e.target.classList.contains("btn-verify-signatures")&&this.verifySignatures(e.target.dataset.permissionId)}),setInterval(()=>{this.updateSignatureStatus()},3e4)}async initiateEmployeeSignature(e){if(this.isProcessing){this.showWarning("Ya hay un proceso de firma en curso");return}this.isProcessing=!0,this.currentPermissionId=e,this.currentStage=1;try{this.showLoading("Iniciando proceso de firma de empleado...");const i=await(await fetch(`/api/firma-peru/initiate-employee/${e}`,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"}})).json();if(!i.success)throw new Error(i.message||"Error al iniciar proceso de firma");await this.startSignatureProcess(i)}catch(t){this.handleSignatureError(t)}finally{this.isProcessing=!1,this.hideLoading()}}async initiateLevel1Signature(e){if(this.isProcessing){this.showWarning("Ya hay un proceso de firma en curso");return}this.isProcessing=!0,this.currentPermissionId=e,this.currentStage=2;try{this.showLoading("Iniciando proceso de aprobaci√≥n y firma de jefe inmediato...");const i=await(await fetch(`/api/firma-peru/initiate-level1/${e}`,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"}})).json();if(!i.success)throw new Error(i.message||"Error al iniciar proceso de firma");await this.startSignatureProcess(i)}catch(t){this.handleSignatureError(t)}finally{this.isProcessing=!1,this.hideLoading()}}async initiateLevel2Signature(e){if(this.isProcessing){this.showWarning("Ya hay un proceso de firma en curso");return}this.isProcessing=!0,this.currentPermissionId=e,this.currentStage=3;try{this.showLoading("Iniciando proceso de aprobaci√≥n final y firma de RRHH...");const i=await(await fetch(`/api/firma-peru/initiate-level2/${e}`,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"}})).json();if(!i.success)throw new Error(i.message||"Error al iniciar proceso de firma");await this.startSignatureProcess(i)}catch(t){this.handleSignatureError(t)}finally{this.isProcessing=!1,this.hideLoading()}}async startSignatureProcess(e){if(!await this.waitForFirmaPeruComponent())throw console.error("üö´ Diagn√≥stico del componente FIRMA PER√ö:",{scriptElement:!!document.getElementById("firma-peru-script"),scriptLoaded:this.scriptLoaded,startSignature:typeof window.startSignature,jqFirmaPeru:typeof window.jqFirmaPeru,jQuery:typeof window.jQuery,scriptSrc:this.jsUrl}),new Error("El componente de FIRMA PER√ö no est√° disponible. Verifique que el servicio est√© funcionando y no haya bloqueadores de script.");this.currentParamToken=e.param_token,console.log("Iniciando proceso de firma con datos:",{param_token:e.param_token,js_url:e.js_url,port:e.port}),window.signatureInit=()=>{this.onSignatureInit()},window.signatureOk=()=>{this.onSignatureOk()},window.signatureCancel=()=>{this.onSignatureCancel()};const i=this;window.sendParam=async()=>{try{console.log("sendParam llamado con param_token:",i.currentParamToken);const a=window.location.origin+"/api/firma-peru/param";console.log("URL completa para sendParam:",a);const n=new FormData;n.append("param_token",i.currentParamToken);const c=await fetch(a,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:n});if(c.ok){const o=await c.text();return console.log("Par√°metros recibidos:",o.substring(0,100)+"..."),o}else try{const o=await c.json();throw new Error(o.message||"Error al obtener par√°metros")}catch{throw new Error("Error de comunicaci√≥n con el servidor")}}catch(a){throw console.error("Error en sendParam:",a),a}};const s={param_url:window.location.origin+"/api/firma-peru/param",param_token:i.currentParamToken,document_extension:"pdf"};console.log("Iniciando startSignature con par√°metros:",s),window.startSignature(this.port,btoa(JSON.stringify(s)))}onSignatureInit(){console.log("Proceso de firma iniciado"),this.showInfo("Proceso de firma iniciado. Por favor, siga las instrucciones en la ventana de FIRMA PER√ö."),this.updateButtonState("processing")}onSignatureOk(){console.log("Firma completada exitosamente"),this.showSuccess("¬°Documento firmado exitosamente!"),this.refreshSignatureStatus(),this.updateButtonState("completed"),typeof this.onSignatureComplete=="function"?(console.log("üîÑ Ejecutando callback onSignatureComplete..."),this.onSignatureComplete()):setTimeout(()=>{window.location.reload()},2e3)}onSignatureCancel(){console.log("Proceso de firma cancelado"),this.showWarning("Proceso de firma cancelado por el usuario"),this.updateButtonState("ready")}updateButtonState(e){const t=this.currentPermissionId,i=this.currentStage;if(!t||!i)return;const r=i===1?".btn-sign-employee":i===2?".btn-sign-level1":".btn-sign-level2",s=document.querySelector(`${r}[data-permission-id="${t}"]`);if(s)switch(e){case"processing":s.disabled=!0,s.innerHTML='<i class="fas fa-spinner fa-spin"></i> Firmando...';break;case"completed":s.disabled=!0,s.innerHTML='<i class="fas fa-check"></i> Firmado',s.classList.add("bg-green-500");break;case"ready":s.disabled=!1,s.innerHTML=this.getOriginalButtonText(i);break}}getOriginalButtonText(e){switch(e){case 1:return'<i class="fas fa-pen"></i> Firmar como Empleado';case 2:return'<i class="fas fa-check-circle"></i> Aprobar y Firmar';case 3:return'<i class="fas fa-stamp"></i> Aprobaci√≥n Final RRHH';default:return"Firmar"}}async verifySignatures(e){try{this.showLoading("Verificando integridad de firmas...");const i=await(await fetch(`/api/firma-peru/verify-signatures/${e}`,{method:"GET",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}})).json();if(i.success)this.showVerificationResults(i);else throw new Error(i.message||"Error al verificar firmas")}catch(t){this.showError("Error al verificar firmas: "+t.message)}finally{this.hideLoading()}}showVerificationResults(e){const t=this.createVerificationModal(e);document.body.appendChild(t),setTimeout(()=>{t.classList.add("show")},10)}createVerificationModal(e){const t=document.createElement("div");t.className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 signature-verification-modal";const i=e.all_signatures_valid,r=i?"text-green-600":"text-red-600",s=i?"fas fa-check-circle":"fas fa-exclamation-triangle",a=i?"Todas las firmas son v√°lidas":"Se encontraron problemas en las firmas";return t.innerHTML=`
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full ${i?"bg-green-100":"bg-red-100"}">
                        <i class="${s} ${r} text-xl"></i>
                    </div>
                    <div class="mt-2 px-7 py-3">
                        <h4 class="text-lg font-semibold text-gray-900 text-center">Verificaci√≥n de Firmas Digitales</h4>
                        <p class="text-sm ${r} text-center mt-2 font-medium">${a}</p>
                        <p class="text-xs text-gray-500 text-center">Verificado el: ${new Date(e.verified_at).toLocaleString()}</p>
                        
                        <div class="mt-4">
                            <h5 class="font-medium text-gray-900 mb-2">Detalle de firmas:</h5>
                            <div class="space-y-2">
                                ${e.signature_details.map(n=>`
                                    <div class="border rounded p-3 ${n.integrity_valid&&n.document_exists?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-medium">${this.getStageLabel(n.signature_type)}</p>
                                                <p class="text-sm text-gray-600">Firmado por: ${n.signer}</p>
                                                <p class="text-xs text-gray-500">Fecha: ${new Date(n.signed_at).toLocaleString()}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-xs ${n.integrity_valid?"text-green-600":"text-red-600"}">
                                                    <i class="fas fa-${n.integrity_valid?"check":"times"}"></i>
                                                    ${n.integrity_valid?"√çntegra":"Comprometida"}
                                                </p>
                                                <p class="text-xs ${n.document_exists?"text-green-600":"text-red-600"}">
                                                    <i class="fas fa-${n.document_exists?"file-pdf":"times"}"></i>
                                                    ${n.document_exists?"Archivo OK":"Archivo faltante"}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                `).join("")}
                            </div>
                        </div>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300" onclick="this.closest('.signature-verification-modal').remove()">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        `,t}getStageLabel(e){switch(e){case"employee":return"Etapa 1: Firma del Empleado";case"level1_supervisor":return"Etapa 2: Aprobaci√≥n Jefe Inmediato";case"level2_hr":return"Etapa 3: Aprobaci√≥n Final RRHH";default:return"Firma desconocida"}}async refreshSignatureStatus(){if(this.currentPermissionId)try{const t=await(await fetch(`/api/firma-peru/signature-status/${this.currentPermissionId}`)).json();t.success&&this.updateSignatureDisplay(t)}catch(e){console.error("Error al actualizar estado de firmas:",e)}}async updateSignatureStatus(){const e=document.querySelectorAll("[data-permission-id]");for(const t of e){const i=t.dataset.permissionId;if(i)try{const s=await(await fetch(`/api/firma-peru/signature-status/${i}`)).json();s.success&&this.updateSignatureDisplay(s,i)}catch(r){console.error(`Error al actualizar estado de solicitud ${i}:`,r)}}}updateSignatureDisplay(e,t=null){const i=t||this.currentPermissionId,r=document.querySelector(`[data-permission-id="${i}"] .signature-status`);r&&(r.innerHTML=this.generateSignatureStatusHTML(e))}generateSignatureStatusHTML(e){if(e.total_signatures===0)return'<p class="text-gray-500 text-sm">Sin firmas digitales</p>';let t='<div class="signature-progress mb-2">';const i=e.signatures.length/3*100;return t+=`
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${i}%"></div>
            </div>
            <p class="text-xs text-gray-600 mt-1">${e.signatures.length} de 3 firmas completadas</p>
        `,t+='</div><div class="signature-list space-y-1">',e.signatures.forEach(r=>{const s=r.stage===1?"fas fa-user":r.stage===2?"fas fa-user-tie":"fas fa-building",a=r.integrity_valid?"fas fa-check text-green-500":"fas fa-exclamation-triangle text-red-500";t+=`
                <div class="flex items-center justify-between text-xs">
                    <span><i class="${s}"></i> ${r.signer_name}</span>
                    <span><i class="${a}"></i> ${new Date(r.signed_at).toLocaleDateString()}</span>
                </div>
            `}),t+="</div>",e.is_fully_signed&&(t+='<p class="text-green-600 text-xs font-medium mt-2"><i class="fas fa-check-circle"></i> Completamente firmado</p>'),t}handleSignatureError(e){console.error("Error en proceso de firma:",e),this.showError(e.message||"Error desconocido en el proceso de firma"),this.updateButtonState("ready")}showSuccess(e){this.showNotification(e,"success")}showError(e){this.showNotification(e,"error")}showWarning(e){this.showNotification(e,"warning")}showInfo(e){this.showNotification(e,"info")}showNotification(e,t="info"){const i=document.querySelector(".firma-peru-notification");i&&i.remove();const r=document.createElement("div");r.className="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg firma-peru-notification max-w-md";const s={success:"bg-green-500 text-white",error:"bg-red-500 text-white",warning:"bg-yellow-500 text-black",info:"bg-blue-500 text-white"},a={success:"fas fa-check-circle",error:"fas fa-times-circle",warning:"fas fa-exclamation-triangle",info:"fas fa-info-circle"};r.className+=` ${s[t]}`,r.innerHTML=`
            <div class="flex items-center">
                <i class="${a[t]} mr-2"></i>
                <span>${e}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-lg">√ó</button>
            </div>
        `,document.body.appendChild(r),setTimeout(()=>{r.parentNode&&r.remove()},t==="error"?8e3:5e3)}showLoading(e="Procesando..."){const t=document.createElement("div");t.className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 firma-peru-loading",t.innerHTML=`
            <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                <i class="fas fa-spinner fa-spin text-3xl text-blue-500 mb-4"></i>
                <p class="text-gray-700">${e}</p>
            </div>
        `,document.body.appendChild(t)}hideLoading(){const e=document.querySelector(".firma-peru-loading");e&&e.remove()}}document.addEventListener("DOMContentLoaded",()=>{window.firmaPeruIntegration=new d});window.FirmaPeruIntegration=d;
